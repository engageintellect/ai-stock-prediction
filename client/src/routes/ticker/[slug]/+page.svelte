<script lang="ts">
	import { tick } from 'svelte';
	import type { PageData } from './$types';
	export let data: PageData;

	function formatPercent(number: Number) {
		if (number) {
			return (Number(number) * 100).toFixed(2);
		}
	}
	function formatPrice(number: Number) {
		if (number) {
			return number.toLocaleString('en-US', { style: 'currency', currency: 'USD' });
		}
	}

	let predicted_prices = data.predicted_prices.map((price: any) => {
		return {
			date: new Date(price.date).toLocaleDateString('en-US'),
			price: formatPrice(price.price)
		};
	});

	let ticker = {
		info: {
			symbol: data.ticker?.toUpperCase(),
			name: data.ticker_info?.shortName,
			currentPrice: formatPrice(data.ticker_info?.currentPrice),
			website: data.ticker_info?.website,
			city: data.ticker_info?.city,
			state: data.ticker_info?.state,
			employees: data.ticker_info?.fullTimeEmployees?.toLocaleString('en-US'),
			sector: data.ticker_info?.sectorDisp
		},

		performance: {
			currentPrice: formatPrice(data.ticker_info?.currentPrice),
			yesterdaysClose: formatPrice(data.ticker_info?.previousClose),
			marketCap: formatPrice(data.ticker_info?.marketCap),
			volume: formatPrice(data.ticker_info?.volume),
			open: formatPrice(data.ticker_info?.open),
			low: formatPrice(data.ticker_info?.dayLow),
			close: formatPrice(data.ticker_info?.dayHigh)
		},

		analysis: {
			recommendation: data.ticker_info?.recommendationKey?.toUpperCase(),
			debtTpEquity: data.ticker_info?.debtToEquity,
			freeCashFlow: formatPrice(data.ticker_info?.freeCashflow),
			ebitda: formatPrice(data.ticker_info?.ebitda),
			shortRatio: data.ticker_info?.shortRatio,
			shortFloat: formatPercent(data.ticker_info?.shortPercentOfFloata ?? 0),
			beta: data.ticker_info?.beta,
			fiftyTwoWeekLow: formatPrice(data.ticker_info?.fiftyTwoWeekLow),
			fiftyTwoWeekHigh: formatPrice(data.ticker_info?.fiftyTwoWeekHigh)
		}
	};
</script>

<div class="">
	{#if !data}
		<div>Loading...</div>
	{:else}
		<div class="flex flex-col gap-5">
			<div class="flex flex-col">
				<div class="flex items-start gap-2">
					<div class="flex items-center gap-5 text-7xl uppercase">
						<div>
							{ticker.info.symbol}
						</div>

						{#if ticker.performance && ticker.performance.currentPrice && ticker.performance.yesterdaysClose && ticker.performance.currentPrice > ticker.performance.yesterdaysClose}
							<div
								class="badge badge-primary text-primary-content h-full px-4 py-2 text-3xl font-thin"
							>
								{ticker.info.currentPrice}
							</div>
						{:else}
							<div class="badge badge-error text-error-content h-full px-4 py-2 text-3xl font-thin">
								{ticker.info.currentPrice}
							</div>
						{/if}
					</div>
				</div>

				<div class="text-xl font-thin uppercase">{ticker.info.name}</div>

				<div class="flex flex-col gap-5 text-sm font-thin">
					<div class="">
						<div>
							<span class="font-semibold">Website:</span>
							<a href={ticker.info.website} target="_blank">{ticker.info.website}</a>
						</div>

						<div>
							<span class="font-semibold">Location:</span>
							{ticker.info.city}, {ticker.info.state}
						</div>

						<div>
							<span class="font-semibold">Employees:</span>
							{ticker.info.employees}
						</div>

						<div>
							<span class="font-semibold">Sector:</span>
							{ticker.info.sector}
						</div>
					</div>
				</div>
			</div>

			<div class="">
				<div class="font-semibold">Analyst Data:</div>
				<div class="flex gap-2 overflow-auto">
					{#each Object.entries(ticker) as [key, value]}
						<div class="bg-accent text-accent-content rounded p-6">
							{#each Object.entries(value) as x}
								{#if x[1]}
									<div class="flex gap-2">
										<div class="capitalize">{x[0]}:</div>
										<div class="font-thin">{x[1]}</div>
									</div>
								{/if}
							{/each}
						</div>
					{/each}
				</div>
			</div>

			<div class="">
				<div class="font-semibold">Analysis Data:</div>
				<div class="flex gap-2 overflow-auto">
					{#each Object.entries(ticker.analysis) as [key, value]}
						{#if value}
							<div class="bg-secondary text-secondary-content rounded p-6">
								<div class="flex flex-col items-center justify-center gap-2">
									<div class="font-thin capitalize">{key}:</div>
									<div class="text-xl font-semibold uppercase">{value}</div>
								</div>
							</div>
						{/if}
					{/each}
				</div>
			</div>

			<div class="">
				<div class="font-semibold">30 AI Day Forecast:</div>
				<div class="flex gap-2 overflow-auto">
					{#each predicted_prices as price}
						<div class="bg-primary text-primary-content rounded p-6 text-center">
							<div class="flex flex-col items-center justify-center gap-2">
								<div class="w-full text-nowrap text-sm font-thin">{price.date}</div>
								<div class="text-xl font-semibold uppercase">{formatPrice(price.price)}</div>
							</div>
						</div>
					{/each}
				</div>
			</div>

			{#if data.ticker_info.longBusinessSummary}
				<div>
					<div class="font-semibold">Description:</div>
					<div>{data.ticker_info.longBusinessSummary}</div>
				</div>
			{/if}
		</div>
		<a class="btn btn-primary my-5" href={ticker.info.website}>Learn More</a>

		<div class="my-2 grid grid-cols-1 gap-2 sm:grid-cols-2 lg:grid-cols-3">
			{#each predicted_prices as price}
				<div class="bg-base-300 rounded p-2">
					<div class="w-full">{price.date}</div>
					<div class="w-full">{price.price}</div>
				</div>
			{/each}
		</div>
	{/if}
</div>
